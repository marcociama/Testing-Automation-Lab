name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: maven

      - name: Build and Test with Maven
        # compila ed esegue i test calcolando la copertura
        run: mvn clean test

      - name: Run Dynamic Linker
        # genera il file input.csv necessario per tsDetect tramite lo script python
        run: python3 utils/linker.py

      - name: Download tsDetect
        # scarico tsDetect da internet ogni volta, cosÃ¬ non devo caricarlo nella repo (per pulizia)
        run: curl -L -o TestSmellDetector.jar https://github.com/TestSmells/TestSmellDetector/releases/download/v2.2/TestSmellDetector.jar

      - name: Run Test Smell Detection
        # esecuzione tsDetect
        run: |
          # pulizia preventiva per far si che il * trovi un solo file nuovo
          rm -f smells_output.csv
          rm -f Output_TestSmellDetection_*.csv
            
          # eseguo tsDetect
          java -jar TestSmellDetector.jar input.csv smells_output.csv
            
          # sposto il file creato in quello standard, eliminando automaticamente il file Output_TestSmellDetection_*.csv
          mv Output_TestSmellDetection_*.csv smells_output.csv
            
          echo "Smell report salvato in smells_output.csv"

      - name: Upload Artifacts
        # salvo sia il report di copertura che quello degli smells
        uses: actions/upload-artifact@v4
        with:
          name: automation-reports
          path: |
            target/site/jacoco/
            smells_output.csv

      - name: Update README with Results
        # estrae i dati e aggiorna il README dinamicamente
        run: |
          # calcolo il numero totale di smells dal CSV
          # conto quante volte appare 1 nelle colonne degli smells.
          TOTAL_SMELLS=$(grep -o ",1" smells_output.csv | wc -l | xargs)
            
          # calcolo percentuale copertura di Jacoco: carico tutte le righe saltando l'intestazione, colonna 3 sono le istruzioni non coperte e colonna 4 quelle coperte e calcolo la somma per ogni riga.
          # la percentuale di cov si calcola come 100 * coperte / (mancate+coperte)
          COVERAGE=$(python3 -c "import csv; data=list(csv.reader(open('target/site/jacoco/jacoco.csv')))[1:]; missed=sum(int(r[3]) for r in data); covered=sum(int(r[4]) for r in data); print(int(100*covered/(covered+missed))) if (covered+missed)>0 else print(0)" 2>/dev/null || echo "0")
            
          # scrivo sui placeholder nel README col comando sed
          sed -i "s/<!-- coverage -->/$COVERAGE/" README.md
          sed -i "s/<!-- smells -->/$TOTAL_SMELLS/" README.md

      - name: Commit and Push changes
        # permette alla pipeline di scrivere sul repository
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: update README with coverage and smells [skip ci]" || echo "No changes to commit"
          git push